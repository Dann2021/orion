{% set nom = model.nom | lower %}
{% set classe = model.nom | capitalize %}
{% set blue_print = nom ~ '_bp' %}
{% set com = "Ajout du contexte de la session de la base de donnée " %}
{% set com404 = "# Si la ressource n'existe pas, une erreur 404 est levé" %}
{# modele pour les routes #}
from flask import Blueprint, jsonify, request, abort
from modeles.models import {{ classe }}
from utils.utils import success, error
from database import get_db
{% if session %}
from flask import session
{% endif %}

# creation du blueprint_{{ nom }}
{{ blue_print }} = Blueprint("{{ nom }}s", __name__, url_prefix="/api/{{ nom }}s")

# creation  d'un CRUD (Create, Read, Update, Delete)
# La création de cette api suit le pattern RESTful


# Creation de la ressource {{ nom }} 
@{{ blue_print }}.post("/")
def creer_ressource_{{ nom }}():

    # {{ com }}
    with get_db() as db:

        # creation du data_get pour recuperer les donnees du POST
        data = request.get_json()

        # creation d'une instance de la classe {{ classe }}
        {{ nom }} = {{ model.nom }}(
        {% for element in model.attributs %}
            {{ element.nom }} = data.get("{{ element.nom }}"),
        {% endfor %})

        # Ajout dans la session 
        db.add({{ nom }})
        db.commit()

        {# creation de la session #}
        {% if session %}
        # Stockage de l'id généré en session
        session["{{ nom }}_id"] = {{ nom }}.id
        {% endif %}
        return jsonify({{ nom }}.data_{{ nom }}()), 201


# route pour voir une ressource
@{{ blue_print }}.get("/<int:id>")
def recuperer_ressource_{{ nom }}(id):

    # {{ com }}
    with get_db() as db:

        # verification de l'existence de la ressource
        {{ nom }} = db.query({{ classe }}).filter({{ classe }}.id == id).first()

        if not {{ nom }}:
            {{ com404 }}
            abort(404) 
        return jsonify({"{{ nom }}": {{ nom }}.data_{{ nom }}() }), 200


# READ LIST (pagination + filtres)

@{{ blue_print }}.get("/all")
def list_{{ nom }}s():
    with get_db() as db:

        # creation de la pagination + filtres
        limit = request.args.get("limit", 20, type=int)
        offset = request.args.get("offset", 0, type=int)
        query = db.query({{ classe }})

        {% for attr in model.attributs %}
        if "{{ attr.nom }}" in request.args:
            query = query.filter({{ classe }}.{{ attr.nom }} == request.args.get("{{ attr.nom }}"))
        {% endfor %}

        total = query.count()
        items = query.offset(offset).limit(limit).all()

        return success(
            data={{ classe }}.list_data(items),
            meta={
                "total": total,
                "limit": limit,
                "offset": offset
            }
        )


# route pour mettre a jour une ressource
@{{ blue_print }}.put("/<int:id>")
def mettre_a_jour_ressource_{{ nom }}(id):

    # {{ com }}
    with get_db() as db:

        # verification de l'existence de la ressource
        {{ nom }} = db.query({{ classe }}).filter({{ classe }}.id == id).first()

        if not {{ nom }}:
            {{ com404 }}
            abort(404)

        # recuperation des donnees du PUT
        data = request.get_json()

        # mise a jour des attributs
        {% for element in model.attributs %}
        if "{{ element.nom }}" in data:
            {{ nom }}.{{ element.nom }} = data.get("{{ element.nom }}")
        {% endfor %}

        db.commit()

        return jsonify({"{{ nom }}": {{ nom }}.data_{{ nom }}() }), 200


# route pour voir toutes les ressources
@{{ blue_print }}.get("/")
def recuperer_ressources_{{ nom }}():

    # {{ com }}
    with get_db() as db:

        # verification de l'existence de la ressource
        {{ nom }}_list = db.query({{ classe }}).all()

        if not {{ nom }}_list:
            {{ com404 }}
            abort(404)

        return jsonify({"{{ nom }}s": {{ classe }}.list_data({{ nom }}_list)}), 200


# route pour supprimer une ressource 
@{{ blue_print }}.delete("/<int:id>")
def supprimer_ressource_{{ nom }}(id):

    # {{ com }}
    with get_db() as db:

        # verification de l'existence de la ressource
        {{ nom }} = db.query({{ classe }}).filter({{ classe }}.id == id).first()

        if not {{ nom }}:
            {{ com404 }}
            abort(404)

        db.delete({{ nom }})
        db.commit()
        
        return jsonify({"message": "ressource supprimée avec succes" }), 200



{% if relations | length > 0 %}
# routes pour les relations

{# ici on parcourt chaque relation #}
    {% for rel in relations %}
    {# ici on teste pour voir si la source de la relation est égale au nom de la classe #}

        {% if rel.source == classe %}
from modeles.models import {{ rel.cible }}

# route pour voir les {{ rel.cible }}s d'une ressource {{ rel.source }}
@{{ blue_print }}.get("/<int:id>/{{ rel.champ }}")
def recuperer_ressource_lie_{{ nom }}_{{ rel.champ }}(id):

    # {{ com }}
    with get_db() as db:

        # verification de l'existence de la ressource
        ressource = db.query({{ rel.source }}).filter({{ rel.source }}.id == id).first()

        if not ressource:
            {{ com404 }}
            abort(404)

        # recuperation  des ressources liees
        items = ressource.{{ rel.champ }}
        return jsonify({
            "{{ rel.champ }}": {{ rel.cible }}.list_data(items)
        }), 200

        {% endif %}
    {% endfor %}
{% endif %}
