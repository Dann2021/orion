<!doctype html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/static/css/index.css" />
  <title>{{ project_name }} Â· API Docs</title>
</head>

<body class="conteneur py-5">
  <section class="col gap-5 ai-mil">
    <div class="bloc-12 bloc-myn-9 db-card my-3 w-full p-1">
      <div class="pill">
        <h3 class="orion-title">Orion - API Docs</h3>
      </div>

      <div class="tag mh-3">
        <h3>{{ project_name }}</h3>
      </div>
      <p class="my-5">
        Documentation auto-generee pour votre backend Flask / SQLAlchemy.
        Toutes les routes CRUD et relations sont listees ci-dessous.
      </p>
      <div class="aff-flex fd-col fd-myn-ligne fd-pt-ligne jc-sb gap-5">
        <div class="bloc-12 bloc-myn-3 bloc-pt-3 db-card">
          <h4 class="mb-1">Base URL</h4>
          <span style="background: var(--bg-surface-2)" class="p-1 ronde-1 code-key">/</span>
        </div>
        <div class="bloc-12 bloc-myn-3 bloc-pt-3 db-card">
          <h4 class="mb-1">API Prefix</h4>
          <span style="background: var(--bg-surface-2)" class="p-1 ronde-1 code-key">/api</span>
        </div>
        <div class="bloc-12 bloc-myn-3 bloc-pt-3 db-card">
          <h4 class="mb-1">Auth</h4>
          <div class="p-1 ronde-1 code-key auth-value" style="background: var(--bg-surface-2)">
            <code>
                {% if auth and auth.get("type") %}
                  {{ auth.get("type") }}
                {% else %}
                  none
                {% endif %}
              </code>
          </div>
        </div>

        <div class="bloc-12 bloc-myn-3 bloc-pt-3 db-card">
          <h4 class="mb-1">Models</h4>
          <div style="background: var(--bg-surface-2)" class="p-1 ronde-1 code-key">
            <code>{{ models|length }}</code>
          </div>
        </div>
      </div>
    </div>

    <div class="bloc-12 bloc-myn-9 db-card my-3 w-full">
      <h2>Quick Start</h2>
      <div class="bloc-12 bloc-myn-7 mh-1">
        {% if models|length > 0 %}
        <pre class="code-key">curl -X GET http://localhost:5000/api/{{ models[0].nom|lower }}s</pre>
        {% else %}
        <pre class="code-key">Aucun modele defini.</pre>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="col gap-5 ai-mil">
    <div class="bloc-12 bloc-myn-9 endpoint-card my-3 w-full p-1">
      <h2>Endpoints</h2>
      <div class="aff-flex fd-col gap-5 mh-4 h-5 overy-auto">
        {% for model in models %}
        <div class="mh-2">
          <h4>{{ model.nom }}</h4>
          <div class="endpoint">
            <span class="mb-1 http-method http-get">GET</span>
            <code style="background: var(--bg-surface)" class="p-1 ronde-1">/api/{{ model.nom | lower }}s</code>
            <span>Lister toutes les ressources</span>
          </div>

          <div class="endpoint">
            <span class="mb-1 http-method http-post">POST</span>
            <code style="background: var(--bg-surface)" class="p-1 ronde-1">/api/{{ model.nom | lower }}s</code>
            <span>Creer une ressource</span>
          </div>

          <div class="endpoint">
            <span class="mb-1 http-method http-get">GET</span>
            <code style="background: var(--bg-surface)"
              class="p-1 ronde-1">/api/{{ model.nom | lower }}s/&lt;id&gt;</code>
            <span>Recuperer une ressource</span>
          </div>

          <div class="endpoint">
            <span class="mb-1 http-method http-put">PUT</span>
            <code style="background: var(--bg-surface)"
              class="p-1 ronde-1">/api/{{ model.nom | lower }}s/&lt;id&gt;</code>
            <span>Mettre a jour une ressource</span>
          </div>

          <div class="endpoint">
            <span class="mb-1 http-method http-delete">DELETE</span>
            <code style="background: var(--bg-surface)"
              class="p-1 ronde-1">/api/{{ model.nom | lower }}s/&lt;id&gt;</code>
            <span>Supprimer une ressource</span>
          </div>
          {% if auth and auth.get("type") == "jwt" and auth.get("classe") == model.nom %}
          <div class="endpoint">
            <span class="mb-1 http-method http-post">POST</span>
            <code style="background: var(--bg-surface)" class="p-1 ronde-1">/api/{{ model.nom | lower }}s/login</code>
            <span>Authentification JWT</span>
          </div>
          <div class="endpoint">
            <span class="mb-1 http-method http-post">POST</span>
            <code style="background: var(--bg-surface)"
              class="p-1 ronde-1">/api/{{ model.nom | lower }}s/refresh</code>
            <span>Renouveler le token d'acces</span>
          </div>
          <div class="endpoint">
            <span class="mb-1 http-method http-get">GET</span>
            <code style="background: var(--bg-surface)" class="p-1 ronde-1">/api/{{ model.nom | lower }}s/me</code>
            <span>Recuperer l'utilisateur courant</span>
          </div>
          {% endif %}
          <div class="query-info">
            <div class="query-label">Query params:</div>
            <div class="query-list">
              <span class="chip">limit</span>
              <span class="chip">offset</span>
              {% for attr in model.attributs %}
              <span class="chip">{{ attr.nom }}</span>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    {% if relations and relations|length > 0 %}
    <div class="bloc-12 bloc-myn-9 endpoint-card my-3 w-full p-1">
      <div class="aff-flex fd-col gap-5 mh-4">
        <h4>Relations</h4>
        {% for rel in relations %}
        <div class="endpoint">
          <span class="mb-1 http-method http-get">GET</span>
          <code style="background: var(--bg-surface)"
            class="p-1 ronde-1">/api/{{ rel.source|lower }}s/&lt;id&gt;/{{ rel.champ }}</code>
          <span>{{ rel.source }} -> {{ rel.cible }} ({{ rel.type }})</span>
        </div>
        <div class="endpoint">
          <span class="mb-1 http-method http-post">POST</span>
          <code style="background: var(--bg-surface)"
            class="p-1 ronde-1">/api/{{ rel.source|lower }}s/&lt;id&gt;/{{ rel.champ }}</code>
          <span>Creer une ressource liee a {{ rel.source }}</span>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </section>

  <section class="aff-flex fd-col fd-myn-ligne jc-mil gap-5 p-myn-2">
    <form class="bloc-12 bloc-myn-5 db-card tester-form" id="tester-form">
      <h3>Api tester</h3>

      <div class="aff-flex fd-col gap-2 my-2">
        <label for="tester-method">Method</label>
        <select name="tester-method" id="tester-method">
          <option>GET</option>
          <option>POST</option>
          <option>PUT</option>
          <option>DELETE</option>
        </select>
      </div>

      <div class="aff-flex fd-col gap-2 my-2">
        <label for="tester-url">URL</label>
        <div class="aff-flex gap-3 ai-mil">
          <span class="ronde p-1 url-prefix" id="tester-base" style="background: var(--bg-surface-2)"></span>
          <input id="tester-url" class="testeur-url" type="text" placeholder="/api/..." />
        </div>
      </div>

      <div class="aff-flex fd-col gap-2 my-3">
        <label for="tester-headers">Headers (JSON)</label>
        <textarea id="tester-headers" rows="4">
{ "Content-Type": "application/json" }</textarea>
      </div>

      <div class="aff-flex fd-col gap-2 my-3">
        <label for="tester-body">Body (JSON)</label>
        <textarea id="tester-body" rows="7" class="texteArea">{}</textarea>
      </div>

      <div class="aff-flex fd-col gap-2 my-3">
        <button id="tester-send" type="submit" class="bouton ronde-1 bouton-succes">Send Request</button>
        <div class="hint">Tip: GET/DELETE ignore body.</div>
      </div>

      <div id="tester-error" class="error"></div>

      <div class="quick-endpoints">
        <div class="quick-title">Quick endpoints</div>
        <div class="quick-list">
          {% if models|length == 0 %}
          <span class="muted">Aucun endpoint.</span>
          {% endif %}
          {% for model in models %}
          <button class="bouton quick-btn" type="button" data-method="GET" data-path="/api/{{ model.nom|lower }}s">
            GET /api/{{ model.nom|lower }}s
          </button>
          <button class="bouton quick-btn" type="button" data-method="GET" data-path="/api/{{ model.nom|lower }}s/1">
            GET /api/{{ model.nom|lower }}s/1
          </button>
          <button class="bouton quick-btn" type="button" data-method="POST" data-path="/api/{{ model.nom|lower }}s"
            data-fields="{% for attr in model.attributs %}{{ attr.nom }}:{{ attr.type }}{% if not loop.last %},{% endif %}{% endfor %}">
            POST /api/{{ model.nom|lower }}s
          </button>
          {% endfor %}
        </div>
      </div>
    </form>
    <div class="bloc-12 bloc-myn-4 tester-response">
      <h3>Response api</h3>
      <div class="response-header aff-flex jc-sb">
        <div>Status: <span id="tester-status" class="status">-</span></div>
        <div>Time: <span id="tester-time">-</span></div>
      </div>

      <pre id="tester-output" class="overx-auto lh-2 p-2 tester-output couleur-vert-sauge h-5 overy-auto">{}</pre>
    </div>
  </section>

  <section class="col gap-5 ai-mil">
    <div class="bloc-12 bloc-myn-9 db-card my-3 w-full p-1">
      <h2>Models</h2>
      {% for model in models %}
      
      <div class="model-card">
        <div class="group-title">{{ model.nom }}</div>
        <div class="table">
          <div class="row header">
            <div>Field</div>
            <div>Type</div>
            <div>Options</div>
          </div>
          {% for attr in model.attributs %}
          <div class="row">
            <div><code>{{ attr.nom }}</code></div>
            <div>{{ attr.type }}</div>
            <div class="options">
              {% if attr.get("primary_key") %}<span class="chip">pk</span>{% endif %}
              {% if attr.get("unique") %}<span class="chip">unique</span>{% endif %}
              {% if attr.get("index") %}<span class="chip">index</span>{% endif %}
              {% if attr.get("nullable") is defined and not attr.get("nullable") %}<span class="chip">not-null</span>{% endif %}
              {% if attr.get("default") is defined %}<span class="chip">default={{ attr.get("default") }}</span>{% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
  </section>

  <footer style="margin-top: 40px; color: var(--text-muted); text-align: center; font-size: 0.9rem; padding: 20px;">
    <div>Genere par Orion - {{ author }}</div>
  </footer>

  <script>
    (function () {
      const form = document.getElementById("tester-form");
      const methodEl = document.getElementById("tester-method");
      const urlEl = document.getElementById("tester-url");
      const headersEl = document.getElementById("tester-headers");
      const bodyEl = document.getElementById("tester-body");
      const statusEl = document.getElementById("tester-status");
      const timeEl = document.getElementById("tester-time");
      const outputEl = document.getElementById("tester-output");
      const errorEl = document.getElementById("tester-error");
      const baseEl = document.getElementById("tester-base");

      function setError(message) {
        errorEl.textContent = message || "";
      }

      function normalizeUrl(value) {
        if (!value) return "";
        if (value.startsWith("http://") || value.startsWith("https://")) {
          return value;
        }
        if (!value.startsWith("/")) return "/" + value;
        return value;
      }

      function sampleValue(type) {
        const t = String(type || "").toLowerCase();
        if (t.includes("int")) return 1;
        if (t.includes("float") || t.includes("double") || t.includes("numeric")) return 1.5;
        if (t.includes("bool")) return false;
        if (t.includes("datetime")) return "2024-01-01T10:00:00Z";
        if (t === "date") return "2024-01-01";
        if (t.includes("json")) return {};
        return "string";
      }

      function buildSample(fieldsText) {
        if (!fieldsText) return {};
        const obj = {};
        fieldsText.split(",").forEach((pair) => {
          const parts = pair.split(":");
          const name = (parts[0] || "").trim();
          const type = (parts[1] || "").trim();
          if (!name) return;
          obj[name] = sampleValue(type);
        });
        return obj;
      }

      function setStatus(value, ok) {
        statusEl.textContent = value;
        statusEl.classList.remove("ok", "bad");
        statusEl.classList.add(ok ? "ok" : "bad");
      }

      baseEl.textContent = window.location.origin;

      document.querySelectorAll(".quick-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const method = btn.dataset.method || "GET";
          const path = btn.dataset.path || "";
          methodEl.value = method;
          urlEl.value = path;
          if (method === "POST" || method === "PUT") {
            const sample = buildSample(btn.dataset.fields);
            bodyEl.value = JSON.stringify(sample, null, 2);
          } else {
            bodyEl.value = "";
          }
        });
      });

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        setError("");
        statusEl.textContent = "-";
        timeEl.textContent = "-";

        const method = methodEl.value;
        const url = normalizeUrl(urlEl.value.trim());
        if (!url) {
          setError("URL manquante.");
          return;
        }

        let headers = {};
        const headersText = headersEl.value.trim();
        if (headersText) {
          try {
            headers = JSON.parse(headersText);
          } catch (err) {
            setError("Headers JSON invalide.");
            return;
          }
        }

        const bodyText = bodyEl.value.trim();
        const options = { method, headers };
        if (method !== "GET" && method !== "DELETE" && bodyText) {
          options.body = bodyText;
        }

        const start = performance.now();
        try {
          const response = await fetch(url, options);
          const elapsed = Math.round(performance.now() - start);
          timeEl.textContent = elapsed + "ms";
          setStatus(response.status + " " + response.statusText, response.ok);

          const contentType = response.headers.get("content-type") || "";
          const text = await response.text();
          if (contentType.includes("application/json")) {
            try {
              const data = JSON.parse(text);
              outputEl.textContent = JSON.stringify(data, null, 2);
            } catch (err) {
              outputEl.textContent = text;
            }
          } else {
            outputEl.textContent = text || "(empty)";
          }
        } catch (err) {
          setStatus("ERROR", false);
          outputEl.textContent = String(err);
        }
      });
    })();
  </script>
</body>

</html>
